<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Updates - Short & Crisp News</title>
    <meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
               img-src 'self' https: data:; 
               font-src 'self' https://fonts.gstatic.com;
               connect-src 'self' https://backend-ml60.onrender.com;">
    
    <link rel="icon" href="image-2.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-meta: #888888;
            --header-gradient-1: #3b82f6;
            --header-gradient-2: #2563eb;
            --border-color: #e5e7eb;
            --accent-color: #3b82f6;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.10);
        }

        [data-theme="dark"] {
            --bg-color: #0f0f0f;
            --card-bg: #1a1a1a;
            --text-primary: #f0f0f0;
            --text-secondary: #c0c0c0;
            --text-meta: #888888;
            --header-gradient-1: #1e3a8a;
            --header-gradient-2: #1e40af;
            --border-color: #2d2d2d;
            --accent-color: #60a5fa;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            padding-bottom: 70px; /* Space for bottom nav */
            overflow-x: hidden;
            color: var(--text-primary);
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--header-gradient-1), var(--header-gradient-2));
            color: #fff;
            padding: 0.9rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .menu-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.4rem;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
        }

        .header-center {
            display: flex;
            align-items: center;
        }

        .logo { height: 35px; width: 35px; margin-right: 10px; border-radius: 8px; }
        h1 { font-size: 1.5rem; font-weight: 700; }

        /* --- Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            border-top: 1px solid var(--border-color);
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-meta);
            padding: 4px;
            transition: color 0.3s;
        }

        .nav-item.active { color: var(--accent-color); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-label { font-size: 0.7rem; font-weight: 500; }

        /* --- Pages --- */
        .page { display: none; padding-top: 10px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Cards --- */
        .card-list {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .news-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .news-card:active { transform: scale(0.98); }

        .news-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            background: var(--border-color);
        }

        .news-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.4; }
        .news-summary { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        
        .news-meta {
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-meta);
        }

        .source-tag {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-color);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* --- Quick / Reels Section --- */
        .reels-container {
            height: calc(100vh - 130px);
            position: relative;
            max-width: 600px;
            margin: 0 auto;
            overflow: hidden;
            background: #000; /* Dark background for immersive feel */
        }

        .reel {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--card-bg);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            transform: translateY(100%);
            opacity: 0;
            z-index: 1;
        }

        .reel.active { transform: translateY(0); opacity: 1; z-index: 2; }

        .reel-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .reel-title { font-size: 1.3rem; font-weight: 800; margin-bottom: 0.8rem; }
        .reel-content { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; flex-grow: 1; overflow-y: auto; }
        
        .reel-btn {
            display: block;
            background: var(--accent-color);
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 1rem;
        }

        /* --- Navigation Arrow --- */
        .nav-arrow-up {
            position: absolute;
            right: 20px;
            bottom: 100px; /* Above bottom nav */
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 10;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .nav-arrow-up:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }

        .nav-arrow-up svg {
            fill: white;
            width: 24px;
            height: 24px;
        }

        /* --- Sidebar & Modals --- */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 998; display: none; }
        .overlay.active { display: block; }

        .sidebar {
            position: fixed; left: -280px; top: 0; bottom: 0; width: 280px;
            background: var(--card-bg); z-index: 999;
            transition: left 0.3s ease;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        }
        .sidebar.open { left: 0; }
        
        .sidebar-header { padding: 1.5rem; background: var(--header-gradient-1); color: white; font-weight: 700; }
        .sidebar-menu a { display: block; padding: 1rem 1.5rem; color: var(--text-primary); text-decoration: none; border-bottom: 1px solid var(--border-color); }
        
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        .modal-content {
            background: var(--card-bg); width: 90%; max-width: 500px; max-height: 80vh;
            border-radius: 16px; padding: 1.5rem; overflow-y: auto; position: relative;
        }
        .close-modal { position: absolute; right: 1.5rem; top: 1rem; font-size: 1.5rem; cursor: pointer; }

        /* --- Components --- */
        .loading { text-align: center; padding: 2rem; color: var(--text-meta); }
        .error-msg { text-align: center; padding: 2rem; color: #ef4444; }
        
        .contact-reveal { 
            color: var(--accent-color); 
            cursor: pointer; 
            text-decoration: underline;
            font-weight: 600;
        }

        /* Toggles */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
        .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }

    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">Menu</div>
        <div class="sidebar-menu">
            <a href="#" id="settingsLink">‚öôÔ∏è Settings</a>
            <a href="#" id="aboutLink">‚ÑπÔ∏è About</a>
            <a href="#" id="helpLink">‚ùì Help & Support</a>
        </div>
    </div>
    <div class="overlay" id="overlay"></div>

    <header>
        <div class="header-left">
            <button class="menu-btn" id="menuBtn">‚ò∞</button>
        </div>
        <div class="header-center">
            <img src="image-2.png" alt="Logo" class="logo" onerror="this.style.display='none'">
            <h1>Updates</h1>
        </div>
        <div style="width: 40px;"></div> </header>

    <div id="homePage" class="page active">
        <div class="card-list" id="homeNewsList">
            <div class="loading">Loading latest news...</div>
        </div>
    </div>

    <div id="quickPage" class="page">
        <div class="reels-container" id="reelsContainer">
            <div class="loading">Preparing Quick News...</div>
        </div>
    </div>

    <div id="headlinesPage" class="page">
        <div class="card-list" id="headlinesList">
            <div class="loading">Fetching Top Headlines...</div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="#" class="nav-item active" data-page="homePage">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">Home</div>
        </a>
        <a href="#" class="nav-item" data-page="quickPage">
            <div class="nav-icon">‚ö°</div>
            <div class="nav-label">Quick</div>
        </a>
        <a href="#" class="nav-item" data-page="headlinesPage">
            <div class="nav-icon">üì∞</div>
            <div class="nav-label">Headlines</div>
        </a>
    </div>

    <div class="modal" id="articleModal">
        <div class="modal-content">
            <span class="close-modal" id="closeArticle">&times;</span>
            <div id="articleContent"></div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <span class="close-modal" id="closeSettings">&times;</span>
            <h2>Settings</h2>
            <div class="setting-row">
                <span>Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-row">
                <span>Language</span>
                <select id="languageSelector" style="padding: 5px; border-radius: 4px;">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                </select>
            </div>
        </div>
    </div>

    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <span class="close-modal" id="closeAbout">&times;</span>
            <h2>About Updates</h2>
            <p style="margin: 10px 0;">Short & Crisp News Aggregator.</p>
            <p><strong>Version:</strong> 1.0.0</p>
            <p style="margin-top:10px;">Aggregates news from World News, NewsAPI, GNews, and more.</p>
        </div>
    </div>

    <div class="modal" id="helpModal">
        <div class="modal-content">
            <span class="close-modal" id="closeHelp">&times;</span>
            <h2>Help & Support</h2>
            <p style="margin: 10px 0;">Contact Developer:</p>
            <p><strong>Email:</strong> <span id="secureEmail" class="contact-reveal">Click to Reveal</span></p>
            <p><strong>Phone:</strong> <span id="securePhone" class="contact-reveal">Click to Reveal</span></p>
        </div>
    </div>

    <script>
        // --- Security: HTML Sanitizer ---
        // Prevents XSS by escaping dangerous characters
        function sanitize(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // --- Security: Obfuscated Contact Data ---
        // Stored as char codes to prevent simple scraping
        // Email: vivivictor.11111@gmail.com
        // Phone: +919919800350
        const _e = [118,105,118,105,118,105,99,116,111,114,46,49,49,49,49,49,64,103,109,97,105,108,46,99,111,109];
        const _p = [43,57,49,57,57,49,57,56,48,48,51,53,48];

        function decodeContact(arr) {
            return String.fromCharCode(...arr);
        }

        document.getElementById('secureEmail').addEventListener('click', function() {
            this.textContent = decodeContact(_e);
            this.style.textDecoration = 'none';
            this.style.color = 'var(--text-primary)';
        });

        document.getElementById('securePhone').addEventListener('click', function() {
            this.textContent = decodeContact(_p);
            this.style.textDecoration = 'none';
            this.style.color = 'var(--text-primary)';
        });

        // --- App State ---
        let currentLang = localStorage.getItem('lang') || 'en';
        let allArticles = [];
        let headlineArticles = []; // Dedicated array for precise headlines
        let currentReelIndex = 0;
        let touchStartY = 0;
        
        const API_BASE = 'https://backend-ml60.onrender.com';

        // --- API Handling ---
        async function fetchAllNews() {
            try {
                console.log('Fetching news...');
                
                // 1. Fetch Top Headlines (World News) - Priority for Headlines Page
                const p1 = fetch(`${API_BASE}/api/worldnews?language=${currentLang}`).then(r => r.json()).catch(e => ({ news: [] }));
                
                // 2. Fetch General News (Others) - For Home/Quick
                const p2 = fetch(`${API_BASE}/api/newsapi?country=in&language=${currentLang}`).then(r => r.json()).catch(e => ({ articles: [] }));
                const p3 = fetch(`${API_BASE}/api/gnews?country=in&lang=${currentLang}`).then(r => r.json()).catch(e => ({ articles: [] }));

                const [worldData, newsApiData, gnewsData] = await Promise.all([p1, p2, p3]);

                // Normalize Data
                // World News (High Quality -> Headlines)
                const worldNews = (worldData.news || []).map(a => ({
                    title: a.title,
                    desc: a.text || a.summary || '',
                    img: a.image,
                    url: a.url,
                    source: 'World News',
                    date: a.publish_date
                }));

                // General News
                const others = [
                    ...(newsApiData.articles || []).map(a => ({
                        title: a.title,
                        desc: a.description || '',
                        img: a.urlToImage,
                        url: a.url,
                        source: a.source?.name || 'NewsAPI',
                        date: a.publishedAt
                    })),
                    ...(gnewsData.articles || []).map(a => ({
                        title: a.title,
                        desc: a.description || '',
                        img: a.image,
                        url: a.url,
                        source: a.source?.name || 'GNews',
                        date: a.publishedAt
                    }))
                ];

                // Filtering invalid items
                headlineArticles = worldNews.filter(a => a.title && a.img);
                // If WorldNews is empty, take top 10 from others for headlines
                if (headlineArticles.length === 0) {
                    headlineArticles = others.slice(0, 10);
                }

                // Combine for Home and Quick
                allArticles = [...worldNews, ...others].filter(a => a.title && a.title !== '[Removed]');
                
                // Shuffle slightly for variety in Home/Quick
                allArticles.sort(() => Math.random() - 0.5);

                renderApp();

            } catch (err) {
                console.error("Fetch error:", err);
                document.getElementById('homeNewsList').innerHTML = '<div class="error-msg">Failed to load news. Check connection.</div>';
            }
        }

        function renderApp() {
            renderHome();
            renderHeadlines();
            renderQuick();
        }

        // --- Render Functions ---
        
        function renderHome() {
            const container = document.getElementById('homeNewsList');
            container.innerHTML = '';
            // Home gets a mix of everything, excluding the very top headlines to avoid duplication if desired,
            // but for aggregation, showing everything is fine.
            allArticles.slice(0, 20).forEach(article => {
                container.appendChild(createCard(article));
            });
        }

        function renderHeadlines() {
            const container = document.getElementById('headlinesList');
            container.innerHTML = '';
            // Headlines page specifically uses the High Quality World News data
            if (headlineArticles.length === 0) {
                container.innerHTML = '<div class="loading">No top headlines found.</div>';
                return;
            }
            headlineArticles.forEach(article => {
                container.appendChild(createCard(article));
            });
        }

        function createCard(article) {
            const el = document.createElement('div');
            el.className = 'news-card';
            el.innerHTML = `
                ${article.img ? `<img src="${sanitize(article.img)}" class="news-image" loading="lazy" onerror="this.style.display='none'">` : ''}
                <div class="news-title">${sanitize(article.title)}</div>
                <div class="news-summary">${sanitize(article.desc)}</div>
                <div class="news-meta">
                    <span class="source-tag">${sanitize(article.source)}</span>
                </div>
            `;
            el.onclick = () => showArticle(article);
            return el;
        }

        function renderQuick() {
            const container = document.getElementById('reelsContainer');
            container.innerHTML = '';
            
            // Quick news needs images. Filter articles with images.
            const reelArticles = allArticles.filter(a => a.img).slice(0, 15);
            
            if (reelArticles.length === 0) {
                container.innerHTML = '<div class="error-msg">No visual news available.</div>';
                return;
            }

            reelArticles.forEach((article, index) => {
                const el = document.createElement('div');
                el.className = `reel ${index === 0 ? 'active' : ''}`;
                el.dataset.index = index;
                
                // Navigation Arrow (Only if not the first reel)
                let navBtn = '';
                if (index > 0) {
                    navBtn = `
                    <div class="nav-arrow-up" onclick="prevReel(event)">
                        <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
                    </div>`;
                }

                el.innerHTML = `
                    <img src="${sanitize(article.img)}" class="reel-image">
                    <div class="reel-title">${sanitize(article.title)}</div>
                    <div class="reel-content">${sanitize(article.desc)}</div>
                    <a href="${sanitize(article.url)}" target="_blank" class="reel-btn">Read Full Story</a>
                    <div style="height: 60px;"></div>
                    ${navBtn}
                `;
                container.appendChild(el);
            });

            // Touch events for swiping
            container.ontouchstart = (e) => touchStartY = e.touches[0].clientY;
            container.ontouchend = (e) => {
                const diff = touchStartY - e.changedTouches[0].clientY;
                if (diff > 50) nextReel();
                if (diff < -50) prevReel();
            };
        }

        // --- Logic: Navigation ---

        function nextReel() {
            const reels = document.querySelectorAll('.reel');
            if (currentReelIndex < reels.length - 1) {
                reels[currentReelIndex].classList.remove('active');
                currentReelIndex++;
                reels[currentReelIndex].classList.add('active');
            }
        }

        function prevReel(e) {
            if(e) e.stopPropagation(); // Prevent triggering other clicks
            const reels = document.querySelectorAll('.reel');
            if (currentReelIndex > 0) {
                reels[currentReelIndex].classList.remove('active');
                currentReelIndex--;
                reels[currentReelIndex].classList.add('active');
            }
        }

        function showArticle(article) {
            const modal = document.getElementById('articleModal');
            const content = document.getElementById('articleContent');
            content.innerHTML = `
                <h2 style="margin-bottom:1rem">${sanitize(article.title)}</h2>
                ${article.img ? `<img src="${sanitize(article.img)}" style="width:100%;border-radius:8px;margin-bottom:1rem">` : ''}
                <p style="line-height:1.6;color:var(--text-secondary)">${sanitize(article.desc)}</p>
                <div style="margin-top:1.5rem;text-align:center">
                    <a href="${sanitize(article.url)}" target="_blank" class="reel-btn" style="display:inline-block;width:auto;padding:10px 20px">Read Original Source</a>
                </div>
            `;
            modal.classList.add('active');
        }

        // --- UI Interactions ---

        // Tab Switching
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                item.classList.add('active');
                document.getElementById(item.dataset.page).classList.add('active');
            });
        });

        // Sidebar & Modals
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        document.getElementById('menuBtn').onclick = () => { sidebar.classList.add('open'); overlay.classList.add('active'); };
        overlay.onclick = () => { sidebar.classList.remove('open'); overlay.classList.remove('active'); };
        
        function openModal(id) {
            document.getElementById(id).classList.add('active');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }
        
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        document.getElementById('settingsLink').onclick = () => openModal('settingsModal');
        document.getElementById('aboutLink').onclick = () => openModal('aboutModal');
        document.getElementById('helpLink').onclick = () => openModal('helpModal');

        document.getElementById('closeSettings').onclick = () => closeModal('settingsModal');
        document.getElementById('closeAbout').onclick = () => closeModal('aboutModal');
        document.getElementById('closeHelp').onclick = () => closeModal('helpModal');
        document.getElementById('closeArticle').onclick = () => closeModal('articleModal');

        // Settings Logic
        const themeToggle = document.getElementById('darkModeToggle');
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            themeToggle.checked = true;
        }
        themeToggle.onchange = () => {
            const theme = themeToggle.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        };

        const langSelect = document.getElementById('languageSelector');
        langSelect.value = currentLang;
        langSelect.onchange = () => {
            currentLang = langSelect.value;
            localStorage.setItem('lang', currentLang);
            fetchAllNews(); // Reload news
        };

        // --- Init ---
        fetchAllNews();

    </script>
</body>
</html>
